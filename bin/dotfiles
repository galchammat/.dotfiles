#!/bin/bash
set -e

# Simple colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Config
DOTFILES_REPO="https://github.com/YOUR-USERNAME/dotfiles.git"
DOTFILES_DIR="$HOME/.dotfiles"

# Detect OS
detect_os() {
  if [ -f /etc/os-release ]; then
    source /etc/os-release
    echo $ID
  else
    echo $(uname -s | tr '[:upper:]' '[:lower:]')
  fi
}

# Install Ansible based on OS
install_ansible() {
  OS=$(detect_os)
  case $OS in
    ubuntu|debian)
      if ! dpkg -s ansible >/dev/null 2>&1; then
        echo -e "${YELLOW}Installing Ansible...${NC}"
        sudo apt-get update
        sudo apt-get install -y software-properties-common
        sudo apt-add-repository -y ppa:ansible/ansible
        sudo apt-get update
        sudo apt-get install -y ansible python3-argcomplete
        echo -e "${GREEN}✓ Ansible installed${NC}"
      fi
      ;;
    arch)
      if ! command -v ansible >/dev/null 2>&1; then
        echo -e "${YELLOW}Installing Ansible...${NC}"
        sudo pacman -Sy --noconfirm ansible python-argcomplete
        echo -e "${GREEN}✓ Ansible installed${NC}"
      fi
      ;;
    fedora)
      if ! command -v ansible >/dev/null 2>&1; then
        echo -e "${YELLOW}Installing Ansible...${NC}"
        sudo dnf install -y ansible python3-argcomplete
        echo -e "${GREEN}✓ Ansible installed${NC}"
      fi
      ;;
    darwin)
      if ! command -v brew >/dev/null 2>&1; then
        echo -e "${YELLOW}Installing Homebrew...${NC}"
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      fi
      if ! command -v ansible >/dev/null 2>&1; then
        echo -e "${YELLOW}Installing Ansible...${NC}"
        brew install ansible
        echo -e "${GREEN}✓ Ansible installed${NC}"
      fi
      ;;
    *)
      echo -e "${RED}Unsupported OS: $OS${NC}"
      exit 1
      ;;
  esac
}

# Setup bare repo
setup_bare_repo() {
  # Helper function to run git commands on bare repo
  config() {
    git --git-dir="$DOTFILES_DIR" --work-tree="$HOME" "$@"
  }

  if ! [[ -d "$DOTFILES_DIR" ]]; then
    echo -e "${YELLOW}Cloning dotfiles as bare repository...${NC}"
    git clone --bare "$DOTFILES_REPO" "$DOTFILES_DIR"
    
    # Hide untracked files
    config config --local status.showUntrackedFiles no
    
    echo -e "${YELLOW}Checking out dotfiles to \$HOME...${NC}"
    
    # Backup existing files if they conflict
    if ! config checkout 2>/dev/null; then
      echo -e "${YELLOW}Backing up existing dotfiles...${NC}"
      mkdir -p "$HOME/.dotfiles-backup"
      config checkout 2>&1 | grep -E "\s+\." | awk '{print $1}' | \
        xargs -I{} sh -c 'mkdir -p "$HOME/.dotfiles-backup/$(dirname {})" && mv "$HOME/{}" "$HOME/.dotfiles-backup/{}"'
      config checkout
      echo -e "${GREEN}✓ Conflicting files backed up to ~/.dotfiles-backup${NC}"
    fi
    
    echo -e "${GREEN}✓ Dotfiles checked out${NC}"
  else
    echo -e "${YELLOW}Updating dotfiles...${NC}"
    config pull
    echo -e "${GREEN}✓ Dotfiles updated${NC}"
  fi

  # Add alias to shell rc files if not present
  ALIAS_LINE='alias dot="git --git-dir=$HOME/.dotfiles --work-tree=$HOME"'
  for rcfile in "$HOME/.bashrc" "$HOME/.zshrc"; do
    if [[ -f "$rcfile" ]] && ! grep -q "alias config=" "$rcfile"; then
      echo "" >> "$rcfile"
      echo "# Dotfiles management alias" >> "$rcfile"
      echo "$ALIAS_LINE" >> "$rcfile"
    fi
  done
}

# Main
echo -e "${BLUE}==================================${NC}"
echo -e "${BLUE}    Dotfiles Setup (Bare Repo)${NC}"
echo -e "${BLUE}==================================${NC}"
echo ""

install_ansible

setup_bare_repo

# Install Galaxy requirements if present
if [ -f "$HOME/.ansible/requirements.yml" ]; then
  echo -e "${YELLOW}Installing Ansible Galaxy dependencies...${NC}"
  ansible-galaxy install -r "$HOME/.ansible/requirements.yml"
elif [ -f "$HOME/requirements.yml" ]; then
  echo -e "${YELLOW}Installing Ansible Galaxy dependencies...${NC}"
  ansible-galaxy install -r "$HOME/requirements.yml"
fi

# Run playbook
if [ -f "$HOME/.ansible/main.yml" ]; then
  echo ""
  echo -e "${BLUE}Running Ansible playbook...${NC}"
  ansible-playbook "$HOME/.ansible/main.yml" "$@"
elif [ -f "$HOME/main.yml" ]; then
  echo ""
  echo -e "${BLUE}Running Ansible playbook...${NC}"
  ansible-playbook "$HOME/main.yml" "$@"
fi

echo ""
echo -e "${GREEN}✓ Setup complete!${NC}"
echo ""
echo -e "${BLUE}Pro tip:${NC} Use ${YELLOW}config${NC} command to manage dotfiles"
echo -e "  Example: ${YELLOW}config status${NC}"
echo -e "  Example: ${YELLOW}config add .bashrc${NC}"
echo -e "  Example: ${YELLOW}config commit -m 'update bashrc'${NC}"
echo ""
